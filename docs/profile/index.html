<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC2U0aM8mUrYoDI0R9pYbzQZk1g9zd96O0",
    authDomain: "oxdyaa.firebaseapp.com",
    projectId: "oxdyaa",
    storageBucket: "oxdyaa.appspot.com",
    messagingSenderId: "604062703590",
    appId: "1:604062703590:web:924c0cbd8a988f4fcf8027"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const currentName = document.getElementById("currentName");
  const displayNameInput = document.getElementById("displayNameInput");
  const editBtn = document.getElementById("editBtn");
  const saveBtn = document.getElementById("saveBtn");
  const photoPreview = document.getElementById("photoPreview");
  const loading = document.getElementById("loading");
  const profileContainer = document.getElementById("profileContainer");

  const pathParts = location.pathname.split("/").filter(Boolean);
  let lastPart = pathParts[pathParts.length - 1];
  let usernameFromURL = (lastPart && lastPart !== "index.html") ? lastPart : null;

  onAuthStateChanged(auth, user => {
    if (!usernameFromURL && user) {
      usernameFromURL = user.displayName || "";
      history.replaceState(null, "", "/profile/" + usernameFromURL);
    }

    loading.style.display = "none";
    profileContainer.style.display = "block";
    currentName.textContent = usernameFromURL || "اسم المستخدم";
    photoPreview.src = "https://via.placeholder.com/100";

    if (user && user.displayName === usernameFromURL) {
      editBtn.style.display = "inline-block";
      photoPreview.src = user.photoURL || "https://via.placeholder.com/100";

      editBtn.onclick = () => {
        displayNameInput.style.display = "block";
        saveBtn.style.display = "inline-block";
        displayNameInput.value = user.displayName || "";
      };

      saveBtn.onclick = async () => {
        try {
          await updateProfile(user, {
            displayName: displayNameInput.value
          });
          currentName.textContent = displayNameInput.value;
          displayNameInput.style.display = "none";
          saveBtn.style.display = "none";
          alert("تم حفظ الاسم الجديد بنجاح!");
        } catch (err) {
          alert("حدث خطأ أثناء الحفظ.");
          console.error(err);
        }
      };
    }
  });
</script>
